<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ThreatSnap Control Panel</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
        background: #111;
        color: white;
        position: relative;
      }
      h1 {
        color: #f33;
      }
      .warning-banner {
        background: #330000;
        color: #ff4d4d;
        padding: 0.8rem 1rem;
        margin-bottom: 1.5rem;
        border-left: 6px solid #ff0000;
        font-weight: bold;
      }
      form,
      .logs,
      .alerts,
      .all-logs,
      .status {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #222;
        border-radius: 8px;
      }
      .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
      }

      .source-preview-container {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
        margin-top: 1.5rem;
      }
      .source-section {
        flex: 1;
      }
      .viewer {
        max-width: 800px;
        margin-top: 0.5rem;
      }
      select,
      input,
      button,
      label {
        padding: 0.5rem;
        font-size: 1rem;
        border-radius: 6px;
        border: 1px solid #444;
        background: #1c1c1c;
        color: white;
      }
      input::placeholder {
        color: #888;
      }
      button {
        background: #333;
        cursor: pointer;
        transition: background 0.2s ease;
        margin-top: 0.5rem;
      }
      button:hover {
        background: #444;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .logs,
      .alerts,
      .all-logs {
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
      }
      a {
        color: #4af;
      }
      .status p {
        margin: 0;
        font-weight: bold;
      }
      .status-running {
        color: lime;
      }
      .status-stopped {
        color: red;
      }
      video {
        width: 100%;
        border-radius: 8px;
      }
      .info-btn {
        position: absolute;
        top: 2rem;
        right: 2rem;
        background: linear-gradient(135deg, #ff4d4d, #ff9933);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        font-weight: bold;
        font-size: 0.95rem;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(255, 77, 77, 0.6);
        animation: pulse 2s infinite;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .info-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 100, 50, 0.8);
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 8px rgba(255, 77, 77, 0.6);
        }
        50% {
          box-shadow: 0 0 16px rgba(255, 153, 51, 0.8);
        }
        100% {
          box-shadow: 0 0 8px rgba(255, 77, 77, 0.6);
        }
      }

      .info-modal {
        display: none;
        position: fixed;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
        background: #222;
        border: 1px solid #444;
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        padding: 1.5rem;
        z-index: 1000;
        color: #eee;
      }
      .info-modal h2 {
        margin-top: 0;
        color: #f33;
      }
      .info-close {
        float: right;
        font-size: 1.2rem;
        cursor: pointer;
        color: #aaa;
      }
      .info-close:hover {
        color: #fff;
      }
      form input[type='email'],
      form select,
      form button,
      form label {
        max-width: 400px;
        width: 100%;
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>ThreatSnap Monitoring</h1>
    <div class="warning-banner">
      ‚ö†Ô∏è First time using ThreatSnap? Click the Info button in the top right to
      understand how it works.
    </div>
    <button class="info-btn" onclick="toggleInfo()">‚ÑπÔ∏è Info</button>

    <div class="info-modal" id="infoModal">
      <span class="info-close" onclick="toggleInfo()">‚úñ</span>
      <h2>About ThreatSnap</h2>
      <p>
        ThreatSnap is a tool that helps detect
        <strong>dangerous situations</strong> by analyzing
        <strong>human movement</strong> in CCTV footage. It‚Äôs designed to run
        <strong>offline</strong> on local devices and works even without
        internet.
      </p>
      <p>
        This demo version works with sample video files and shows how the system
        can monitor scenes, identify suspicious activity, and send alerts when
        needed.
      </p>
      <p>In the future, we plan to add features like:</p>
      <ul>
        <li>Support for <strong>live CCTV camera feeds</strong></li>
        <li>
          <strong>User accounts</strong> to manage alert settings and logs
        </li>
        <li>
          <strong>Cloud or hybrid storage</strong> for threat reports and
          analytics
        </li>
      </ul>
      <p><strong>How to use:</strong></p>
      <ol>
        <li>Select a video file</li>
        <li>Enable email alerts if you want to get notified</li>
        <li>Click <em>Start Monitoring</em></li>
        <li>It will scan the video for movement and take screenshots</li>
        <li>Screenshots are analyzed for risky or dangerous behavior</li>
        <li>If a threat is found, an email alert is sent (if enabled)</li>
      </ol>
    </div>

    <div class="status" id="monitoringStatus">
      <p>Loading monitoring status...</p>
    </div>

    <div id="startFormSection">
      <form method="POST" action="/start">
        <div class="form-group">
          <label>
            <input
              type="checkbox"
              id="enableEmail"
              name="enable_email"
              onchange="toggleEmailField(this.checked)"
            />
            Enable Email Alerts
          </label>
        </div>

        <div class="form-group" id="emailField" style="display: none">
          <label for="email">Email for alerts:</label>
          <input
            type="email"
            name="email"
            id="email"
            placeholder="you@example.com"
          />
        </div>

        <div class="form-group">
          <label for="filename">Select video file:</label>
          <select
            name="filename"
            id="filename"
            onchange="previewVideo(this.value)"
          >
            <option value="">-- Select a video --</option>
            {% for file in video_files %}
            <option value="{{ file }}">{{ file }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="viewer" id="videoViewer" style="display: none">
          <h4>üé• Preview</h4>
          <video id="videoPlayer" controls></video>
        </div>

        <button type="submit" id="startBtn">Start Monitoring</button>
      </form>
    </div>

    <form method="POST" action="/stop">
      <button type="submit" id="stopBtn">Stop Monitoring</button>
    </form>

    <form method="POST" action="/reset">
      <button type="submit">Delete All Logs & Screenshots</button>
    </form>

    <div class="logs">
      <h3>Live Terminal Logs</h3>
      <pre id="logbox">Loading...</pre>
    </div>

    <div class="alerts">
      <h3>‚ö†Ô∏è Critical Alerts</h3>
      <ul id="criticalList"></ul>
    </div>

    <div class="all-logs">
      <h3>üìÅ All Logs</h3>
      <ul id="allLogsList"></ul>
    </div>

    <script>
      function toggleInfo() {
        const modal = document.getElementById('infoModal')
        modal.style.display = modal.style.display === 'block' ? 'none' : 'block'
      }

      function toggleEmailField(enabled) {
        document.getElementById('emailField').style.display = enabled
          ? 'block'
          : 'none'
      }

      function previewVideo(filename) {
        const viewer = document.getElementById('videoViewer')
        const player = document.getElementById('videoPlayer')
        if (filename) {
          player.src = `/static/videos/${filename}`
          viewer.style.display = 'block'
        } else {
          viewer.style.display = 'none'
          player.src = ''
        }
      }

      function fetchLogs() {
        fetch('/logs/live')
          .then((res) => res.json())
          .then((data) => {
            document.getElementById('logbox').textContent = data.join('\n')
          })
      }

      function fetchCriticalAlerts() {
        fetch('/logs/action-required')
          .then((res) => res.json())
          .then((data) => {
            const list = document.getElementById('criticalList')
            list.innerHTML = ''
            if (data.length === 0) {
              list.innerHTML = '<li>No critical alerts.</li>'
            } else {
              data.forEach((entry) => {
                const li = document.createElement('li')
                li.innerHTML = `<b>${entry.timestamp}</b><br>
                <a href="/images/${entry.image}" target="_blank">Image</a> |
                <a href="/images/${entry.timestamp}.json" target="_blank">Log</a><br>
                Danger: ${entry.analysis.danger}`
                list.appendChild(li)
              })
            }
          })
      }

      function fetchAllLogs() {
        fetch('/logs')
          .then((res) => res.json())
          .then((data) => {
            const list = document.getElementById('allLogsList')
            list.innerHTML = ''
            if (data.length === 0) {
              list.innerHTML = '<li>No logs available.</li>'
            } else {
              data.forEach((entry) => {
                const li = document.createElement('li')
                li.innerHTML = `<b>${entry.timestamp}</b><br>
                <a href="/images/${entry.image}" target="_blank">Image</a> |
                <a href="/images/${entry.timestamp}.json" target="_blank">Log</a><br>
                Danger: ${entry.analysis.danger}`
                list.appendChild(li)
              })
            }
          })
      }

      function fetchStatus() {
        fetch('/status')
          .then((res) => res.json())
          .then((data) => {
            const running = data.running
            const statusBox = document.getElementById('monitoringStatus')
            const startBtn = document.getElementById('startBtn')
            const stopBtn = document.getElementById('stopBtn')
            const startFormSection = document.getElementById('startFormSection')

            statusBox.innerHTML = running
              ? '<p class="status-running">üü¢ Monitoring is currently running.</p>'
              : '<p class="status-stopped">üî¥ Monitoring is not running.</p>'

            startBtn.disabled = running
            stopBtn.disabled = !running
            startFormSection.style.display = running ? 'none' : 'block'
          })
      }

      setInterval(fetchLogs, 1000)
      setInterval(fetchCriticalAlerts, 3000)
      setInterval(fetchAllLogs, 5000)
      setInterval(fetchStatus, 1000)

      fetchLogs()
      fetchCriticalAlerts()
      fetchAllLogs()
      fetchStatus()
    </script>
  </body>
</html>
